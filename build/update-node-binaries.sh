#!/bin/bash

# Script to extract GoReleaser build artifacts and update atom-updater-node binaries
#
# Usage: ./build/update-node-binaries.sh [--check-only]
#
# Options:
#   --check-only    Only check for archives without processing them
#
# This script:
# 1. Looks for tar.gz/zip files generated by GoReleaser in the dist/ directory
# 2. Extracts them to the appropriate platform directories in atom-updater-node/bin/
# 3. Cleans up the archive files after extraction
# 4. Sets executable permissions on the binaries

set -e

# Check for --check-only flag
CHECK_ONLY=false
if [ "$1" == "--check-only" ]; then
    CHECK_ONLY=true
fi

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Project paths
PROJECT_ROOT=$(cd "$(dirname "$0")/.." && pwd)
DIST_DIR="$PROJECT_ROOT/dist"
NODE_BIN_DIR="$PROJECT_ROOT/atom-updater-node/bin"

echo -e "${GREEN}üîÑ Updating atom-updater-node binaries from GoReleaser artifacts...${NC}"

# Check if dist directory exists
if [ ! -d "$DIST_DIR" ]; then
    echo -e "${RED}‚ùå Error: dist/ directory not found. Run the release build first.${NC}"
    exit 1
fi

# Check if node bin directory exists
if [ ! -d "$NODE_BIN_DIR" ]; then
    echo -e "${RED}‚ùå Error: atom-updater-node/bin/ directory not found.${NC}"
    exit 1
fi

# Find all binary directories (from goreleaser build)
BINARY_DIRS=$(find "$DIST_DIR" -type d -name "atom-updater_*" | grep -v "source")

if [ -z "$BINARY_DIRS" ]; then
    if [ "$CHECK_ONLY" = true ]; then
        echo -e "${YELLOW}‚ö†Ô∏è  No binary directories found in dist/.${NC}"
        exit 1
    else
        echo -e "${YELLOW}‚ö†Ô∏è  No binary directories found in dist/. Run GoReleaser build first.${NC}"
        exit 0
    fi
fi

echo -e "${GREEN}üì¶ Found binary directories:${NC}"
echo "$BINARY_DIRS" | sed 's/^/  - /'

# Process each binary directory (unless in check-only mode)
if [ "$CHECK_ONLY" = true ]; then
    echo -e "${GREEN}‚úÖ Found $(echo "$BINARY_DIRS" | wc -l) binary directory(ies) ready for processing${NC}"
    echo -e "${GREEN}üì¶ Binary directory list:${NC}"
    echo "$BINARY_DIRS" | sed 's/^/  - /'
    exit 0
fi

while IFS= read -r binary_dir; do
    echo -e "\n${YELLOW}üîç Processing: $(basename "$binary_dir")${NC}"

    # Extract directory name
    dir_name=$(basename "$binary_dir")

    # Determine platform and architecture from directory name
    # Format: atom-updater_{platform}_{arch}_{variant}
    if [[ "$dir_name" =~ atom-updater_([^_]+)_([^_]+)_(.*) ]]; then
        platform_raw="${BASH_REMATCH[1]}"
        arch_raw="${BASH_REMATCH[2]}"
        variant="${BASH_REMATCH[3]}"

        echo -e "  ${GREEN}üìã Parsed: platform=$platform_raw, arch=$arch_raw, variant=$variant${NC}"

        # Map GoReleaser naming to our directory structure
        case "$platform_raw" in
            "darwin") platform_dir="darwin" ;;
            "linux") platform_dir="linux" ;;
            "windows") platform_dir="win32" ;;
            *) echo -e "${RED}‚ùå Unknown platform: $platform_raw${NC}"; continue ;;
        esac

        case "$arch_raw" in
            "amd64") arch_dir="x64" ;;
            "386") arch_dir="ia32" ;;
            "arm64") arch_dir="arm64" ;;
            *) echo -e "${RED}‚ùå Unknown architecture: $arch_raw${NC}"; continue ;;
        esac

        target_dir="$NODE_BIN_DIR/$platform_dir/$arch_dir"

        echo -e "  ${GREEN}üìÇ Target: $target_dir${NC}"

        # Create target directory if it doesn't exist
        mkdir -p "$target_dir"

        # Find the binary file in the source directory
        source_binary="$binary_dir/atom-updater"
        if [[ "$platform_raw" == "windows" ]]; then
            source_binary="$binary_dir/atom-updater.exe"
        fi

        # Check if source binary exists
        if [ ! -f "$source_binary" ]; then
            echo -e "  ${RED}‚ùå Source binary not found: $source_binary${NC}"
            continue
        fi

        # Copy binary to target directory
        target_binary="$target_dir/$(basename "$source_binary")"
        cp "$source_binary" "$target_binary"

        # Set executable permissions
        chmod +x "$target_binary"

        echo -e "  ${GREEN}‚úÖ Binary copied and permissions set${NC}"

    else
        echo -e "  ${YELLOW}‚ö†Ô∏è  Skipping unrecognized directory: $dir_name${NC}"
    fi
done <<< "$BINARY_DIRS"

# Count total binaries installed
total_binaries=0

echo -e "\n${GREEN}üéâ Update complete!${NC}"

# Show summary of what was installed
echo -e "\n${GREEN}üìã Installation Summary:${NC}"
for platform_dir in "$NODE_BIN_DIR"/*/; do
    if [ -d "$platform_dir" ]; then
        platform=$(basename "$platform_dir")
        for arch_dir in "$platform_dir"/*/; do
            if [ -d "$arch_dir" ]; then
                arch=$(basename "$arch_dir")
                binary="$arch_dir/atom-updater"
                if [[ "$platform" == "win32" ]]; then
                    binary="$arch_dir/atom-updater.exe"
                fi

                if [ -f "$binary" ]; then
                    echo -e "  ${GREEN}‚úÖ $platform/$arch${NC}"
                    ((total_binaries++))
                fi
            fi
        done
    fi
done

echo -e "${GREEN}üìä Total binaries installed: $total_binaries${NC}"

echo -e "\n${GREEN}üöÄ atom-updater-node is ready to use!${NC}"